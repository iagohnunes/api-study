generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model auth_identitie {
  id                        String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                   String                      @db.Uuid
  provider                  auth_provider
  provider_user_id          String?
  email                     String?
  email_verified_at         DateTime?                   @db.Timestamptz(6)
  password_hash             String?
  created_at                DateTime                    @default(now()) @db.Timestamptz(6)
  updated_at                DateTime                    @updatedAt @db.Timestamptz(6)
  users                     user                       @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  email_verification_tokens email_verification_token[]

  @@unique([provider, provider_user_id], map: "ux_auth_identities_provider_user")
  @@index([email], map: "ix_auth_identities_email")
  @@index([user_id], map: "ix_auth_identities_user_id")

  @@map("auth_identities")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model email_verification_token {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  identity_id     String          @db.Uuid
  token_hash      String          @unique
  expires_at      DateTime        @db.Timestamptz(6)
  used_at         DateTime?       @db.Timestamptz(6)
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  auth_identities auth_identitie @relation(fields: [identity_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expires_at], map: "ix_email_verif_expires")
  @@index([identity_id], map: "ix_email_verif_identity")

  @@map("email_verification_tokens")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model refresh_token {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  token_hash String    @unique
  expires_at DateTime  @db.Timestamptz(6)
  revoked_at DateTime? @db.Timestamptz(6)
  ip         String?
  user_agent String?
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  users      user     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expires_at], map: "ix_refresh_expires")
  @@index([user_id], map: "ix_refresh_user_id")

  @@map("refresh_tokens")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model user {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String?
  avatar_url      String?
  phone           String?
  status          user_status       @default(PENDING)
  last_login_at   DateTime?         @db.Timestamptz(6)
  created_at      DateTime          @default(now()) @db.Timestamptz(6)
  updated_at      DateTime          @updatedAt @db.Timestamptz(6)
  deleted_at      DateTime?         @db.Timestamptz(6)
  
  auth_identities auth_identitie[]
  refresh_tokens  refresh_token[]
  user_roles      user_role[]
  sessions        session[]
  audit_logs      audit_log[]

  @@index([status])
  @@index([deleted_at])
  @@map("users")
}

enum auth_provider {
  EMAIL
  GOOGLE
  GITHUB
}

enum user_status {
  ACTIVE
  BLOCKED
  PENDING
}

// ==================== SISTEMA DE ROLES E PERMISSÕES ====================

/// Tabela de perfis/funções do sistema
model role {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String            @unique
  description      String?
  created_at       DateTime          @default(now()) @db.Timestamptz(6)
  updated_at       DateTime          @updatedAt @db.Timestamptz(6)
  deleted_at       DateTime?         @db.Timestamptz(6)
  
  user_roles       user_role[]
  role_permissions role_permission[]
  
  @@index([deleted_at])
  @@map("roles")
}

/// Relacionamento entre usuários e roles (Many-to-Many)
model user_role {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String   @db.Uuid
  role_id    String   @db.Uuid
  created_at DateTime @default(now()) @db.Timestamptz(6)
  
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role       role     @relation(fields: [role_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, role_id])
  @@index([user_id])
  @@index([role_id])
  @@map("user_roles")
}

/// Tabela de permissões granulares
model permission {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name             String            @unique
  description      String?
  resource         String
  action           String
  created_at       DateTime          @default(now()) @db.Timestamptz(6)
  
  role_permissions role_permission[]
  
  @@index([resource, action])
  @@map("permissions")
}

/// Relacionamento entre roles e permissões (Many-to-Many)
model role_permission {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role_id       String     @db.Uuid
  permission_id String     @db.Uuid
  created_at    DateTime   @default(now()) @db.Timestamptz(6)
  
  role          role       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission    permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)
  
  @@unique([role_id, permission_id])
  @@index([role_id])
  @@index([permission_id])
  @@map("role_permissions")
}

// ==================== GERENCIAMENTO DE SESSÕES JWT ====================

/// Tabela para controle de sessões JWT ativas
model session {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.Uuid
  token_jti    String    @unique
  ip           String?
  user_agent   String?
  device_info  String?
  expires_at   DateTime  @db.Timestamptz(6)
  revoked_at   DateTime? @db.Timestamptz(6)
  last_used_at DateTime  @updatedAt @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  
  user         user      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([token_jti])
  @@index([expires_at])
  @@map("sessions")
}

// ==================== AUDITORIA E LOGS ====================

/// Tabela de logs de auditoria para segurança e compliance
model audit_log {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String?  @db.Uuid
  action      String
  resource    String?
  resource_id String?
  ip          String?
  user_agent  String?
  metadata    Json?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  
  user        user?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  
  @@index([user_id])
  @@index([action])
  @@index([created_at])
  @@map("audit_logs")
}
